# implement_real_agents.sh

## Overview

Bootstrap script that converts JSON agent definitions into running processes. Creates and launches real agent worker processes based on priority team assignments, transforming static agent configurations into active, working processes that participate in the coordination system.

## Purpose

- Convert JSON agent definitions to running processes
- Bootstrap the agent coordination system
- Create priority-based agent worker processes
- Validate and verify actual running processes
- Generate initial work items for testing

## Prerequisites

- **jq** - JSON processing for agent selection
- **agent_status.json** - Agent registry and configuration
- **coordination_helper.sh** - Integration for agent registration
- **pgrep** - Process management and verification
- **bash** - Advanced shell features (arrays, process substitution)

## Usage

```bash
# Standard implementation
./implement_real_agents.sh

# Monitor running agents after implementation
pgrep -af real_agent_worker

# Check agent processes
ps aux | grep real_agent_worker
```

## Key Features

### Dynamic Agent Worker Creation
- Generates `real_agent_worker.sh` script at runtime
- Embeds complete worker logic in generated script
- Creates self-contained worker processes

### Priority-Based Agent Selection
- Focuses on high-value teams:
  - `meta_8020_team` - Meta-level coordination
  - `reality_team` - Reality validation
  - `coordination_team` - Core coordination
- Fallback to essential agents if priority teams unavailable

### Process Management
- Checks for existing processes before starting
- Prevents duplicate agent workers
- Tracks process IDs for management

### Reality Validation
- Verifies actual running processes vs. intended targets
- Validates agent-to-process mapping
- Confirms coordination system integration

### Work Item Generation
- Creates initial work items for agents to process
- Tests coordination system functionality
- Provides realistic work distribution

## Configuration

### Priority Teams
```bash
PRIORITY_TEAMS=("meta_8020_team" "reality_team" "coordination_team")
```

### Agent Selection Algorithm
1. Query `agent_status.json` for all agents
2. Filter by priority teams
3. Calculate coverage (target 10 agents)
4. Fall back to essential agents if needed

### Essential Agent Fallback
If no priority team agents found, creates:
- `real_coordinator_1` (coordination)
- `real_worker_1` (worker) 
- `real_validator_1` (validation)

## Generated Script Structure

### real_agent_worker.sh Template
```bash
#!/bin/bash
# Real Agent Worker Process - Generated by implement_real_agents.sh

AGENT_ID="$1"
WORK_TYPE="$2"

echo "$(date '+%H:%M:%S') Starting agent: $AGENT_ID ($WORK_TYPE)"

while true; do
    # Poll for work assigned to this agent
    work_ids=$(jq -r --arg agent_id "$AGENT_ID" --arg work_type "$WORK_TYPE" '
        .[] | select(
            (.assigned_to == $agent_id or .work_type == $work_type) and 
            .status == "pending"
        ) | .work_id
    ' ../work_claims.json 2>/dev/null)
    
    if [[ -n "$work_ids" ]]; then
        for work_id in $work_ids; do
            echo "$(date '+%H:%M:%S') Found work: $work_id"
            echo "$(date '+%H:%M:%S') Agent $AGENT_ID starting work on: $work_id"
            
            # Update work status to active
            ../coordination_helper.sh progress "$work_id" 0 "active" >/dev/null 2>&1
            
            # Simulate work execution
            work_duration=$((RANDOM % 5 + 1))
            sleep $work_duration
            
            # Complete the work
            ../coordination_helper.sh complete "$work_id" "success" 8 >/dev/null 2>&1
            
            echo "$(date '+%H:%M:%S') Agent $AGENT_ID completed work: $work_id ($work_duration seconds)"
        done
    else
        echo "$(date '+%H:%M:%S') Agent $AGENT_ID ($WORK_TYPE) polling for work..."
    fi
    
    sleep 2
done
```

## Implementation Process

### Step 1: Agent Selection
```bash
# Query agent_status.json for priority team members
agents=$(jq -r --argjson teams '["meta_8020_team","reality_team","coordination_team"]' '
    .[] | select(.team as $team | $teams | index($team)) | 
    "\(.agent_name):\(.team):\(.capabilities[0] // "general")"
' agent_status.json)
```

### Step 2: Script Generation
- Creates `real_agent_worker.sh` with embedded logic
- Makes script executable
- Validates script creation

### Step 3: Process Launch
```bash
# Start each agent as background process
./real_agent_worker.sh "$agent_name" "$work_type" &
agent_pid=$!
echo "Started agent: $agent_name (PID: $agent_pid)"
```

### Step 4: Verification
```bash
# Verify processes are running
sleep 3
for agent_name in "${started_agents[@]}"; do
    if pgrep -f "real_agent_worker.*$agent_name" >/dev/null; then
        echo "✓ $agent_name is running"
    else
        echo "✗ $agent_name failed to start"
    fi
done
```

### Step 5: Work Item Creation
```bash
# Create initial work items for testing
../coordination_helper.sh claim "coordination" "Test coordination system" "high" "coordination_team"
../coordination_helper.sh claim "validation" "Validate agent processes" "medium" "reality_team"
../coordination_helper.sh claim "analysis" "Run meta-analysis" "low" "meta_8020_team"
```

## Output Example

```
=== IMPLEMENTING REAL AGENTS ===

Found 12 agents from priority teams:
✓ meta_coordinator_1 (meta_8020_team)
✓ reality_validator_1 (reality_team)  
✓ coordination_manager_1 (coordination_team)
...

Creating real_agent_worker.sh script...
✓ Script created and made executable

Starting agent processes:
✓ Started meta_coordinator_1 (PID: 12345)
✓ Started reality_validator_1 (PID: 12346)
✓ Started coordination_manager_1 (PID: 12347)
...

Verification (after 3 seconds):
✓ meta_coordinator_1 is running
✓ reality_validator_1 is running
✓ coordination_manager_1 is running
...

Creating initial work items:
✓ Created 3 test work items

=== IMPLEMENTATION COMPLETE ===
Real agents are now running and processing work!

Monitor with: pgrep -af real_agent_worker
Stop with: pkill -f real_agent_worker
```

## Integration Points

### agent_status.json
- Primary source for agent configurations
- Contains team assignments and capabilities
- Structured format for agent metadata

### coordination_helper.sh
- Agent registration functionality
- Work item creation and management
- Process coordination integration

### real_agent_worker.sh
- Generated worker process script
- Continuous work processing loop
- Coordination system integration

### work_claims.json
- Work queue for agent processing
- Status tracking and assignment
- Atomic work claiming

## Process Management

### Starting All Agents
```bash
./implement_real_agents.sh
```

### Monitoring Agents
```bash
# List all running agents
pgrep -af real_agent_worker

# Show detailed process info
ps aux | grep real_agent_worker

# Monitor specific agent
tail -f /dev/pts/1  # if agent running in terminal
```

### Stopping Agents
```bash
# Stop all agents
pkill -f real_agent_worker

# Stop specific agent
pkill -f "real_agent_worker.*agent_name"

# Graceful shutdown
kill -TERM $(pgrep -f real_agent_worker)
```

## Error Handling

### Agent Selection Fallback
- Falls back to essential agents if priority teams empty
- Ensures minimum viable agent population
- Validates agent configuration before starting

### Process Verification
- Checks if processes actually started
- Reports failed starts
- Provides troubleshooting information

### Script Generation Safety
- Validates script creation
- Makes script executable
- Reports generation errors

## Troubleshooting

### Common Issues

1. **No agents found**
   ```bash
   # Check agent_status.json exists and has content
   ls -la agent_status.json
   jq . agent_status.json
   
   # Verify team assignments
   jq '.[] | .team' agent_status.json | sort | uniq
   ```

2. **Process start failures**
   ```bash
   # Check script permissions
   ls -la real_agent_worker.sh
   
   # Test script manually
   ./real_agent_worker.sh "test_agent" "test" &
   ```

3. **Coordination errors**
   ```bash
   # Verify coordination_helper.sh exists
   ls -la ../coordination_helper.sh
   
   # Test coordination
   ../coordination_helper.sh list-work
   ```

### Debug Mode
```bash
# Add debug output
set -x
./implement_real_agents.sh
```

## Performance Considerations

### Agent Count
- Targets 10 agents for balanced coverage
- Adjusts based on available priority team members
- Monitors system resource usage

### Process Overhead
- Each agent runs as separate process
- Minimal memory footprint per agent
- Efficient polling with 2-second intervals

### Work Distribution
- Priority-based work assignment
- Load balancing across teams
- Prevents work conflicts

## Related Scripts

- `real_agent_worker.sh` - Generated worker process
- `coordination_helper.sh` - Core coordination system
- `agent_swarm_orchestrator.sh` - Swarm-level management
- `quick_start_agent_swarm.sh` - Complete automation

## Use Cases

### Development Environment
- Bootstrap local agent coordination
- Test multi-agent workflows
- Debug coordination system

### Production Deployment
- Convert configurations to processes
- Scale agent workforce
- Monitor system operations

### System Testing
- Validate agent coordination
- Test work distribution
- Verify process management